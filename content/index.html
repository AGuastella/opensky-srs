<!DOCTYPE html>
<html>

<head>
  <title>Live Flight Data Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
  <!-- <script src="https://unpkg.com/@aspnet/signalr@1.0.2/dist/browser/signalr.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>

  <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas-service.min.js"></script>
  <script>
    
    var map, datasource, popup, symbolLayer;

    function GetMap() {
      //Add Map Control JavaScript code here.
       map = new atlas.Map("myMap", {
        //Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
        authOptions: {
          authType: "subscriptionKey",
          subscriptionKey: "2Xi2YAbxLSzp83ZIc_JDsxqxJ_FQsuIhV0MLlVkEOA0",
        },
        style: "night",
        center: [12.56738, 41.87194],
        zoom: 5

      });



      map.events.add("ready", function () {
        //map.imageSprite.createFromTemplate('plane-icon', 'triangle-arrow-up')
        //map.imageSprite.add('plane-icon','https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTKemqAITfXlc1tTnzhgUA7vV98f6hGV_EMtQ&usqp=CAU')
        //map.imageSprite.createFromTemplate('plane-icon', 'triangle-arrow-up')
        //Create a data source and add it to the map
        map.imageSprite.createFromTemplate('myTemplatedIcon', 'triangle-arrow-up', 'teal', '#fff')

//Add a symbol layer that uses the custom created icon.

        datasource = new atlas.source.DataSource();
        map.sources.add(datasource);

        symbolLayer=new atlas.layer.SymbolLayer(datasource, null, {
          iconOptions: {
              image: 'myTemplatedIcon',
              ignorePlacement: true,
              allowOverlap: true,
              size: 0.5,
              rotation: ["get", "rotation"],
          },
        /*  textOptions: {
            textField: [
              "concat",
              ["to-string", ["get", "name"]],
              "- ",
              ["get", "altitude"],
            ],
            color: "#FFFFFF",
            offset: [2, 0],
          },*/
        })
        map.layers.add(symbolLayer);

        
        //Add a symbol layer that uses the custom created icon.
/*        map.layers.add(new atlas.layer.SymbolLayer(datasource, null, {
          iconOptions: {
            ignorePlacement: true,
            allowOverlap: true,
            image: "plane-icon",
            size: 0.08,
            rotation: ["get", "rotation"],
          },
          textOptions: {
            textField: [
              "concat",
              ["to-string", ["get", "name"]],
              "- ",
              ["get", "altitude"],
            ],
            color: "#FFFFFF",
            offset: [2, 0],
          },
        }));
*/



        let messages = document.querySelector('#messages');
        const apiBaseUrl = window.location.origin;
        const connection = new signalR.HubConnectionBuilder()
          .withUrl(apiBaseUrl + '/api')
          .configureLogging(signalR.LogLevel.Information)
          .build();
        /*connection.on('newMessage', (message) => {
          document.getElementById("messages").innerHTML = message;
        });
  */           popup = new atlas.Popup({
                    position: [0, 0],
                    pixelOffset: [0, -18]
                });
        map.events.add('mousemove', closePopup);
        map.events.add('mousemove', symbolLayer, symbolHovered);
        map.events.add('touchstart', symbolLayer, symbolHovered);

        connection.on('newMessage', ProcessFlightData)

        connection.start().catch(console.error);





      });



    }
    async function populate(){
    //const response=await fetch("https://openskyiu.azurewebsites.net/api/flightlist")
    //const response=await fetch("")
    //console.log(response.json())
    /*fetch('http://localhost:7071/api/flightlist')
   .then(response => {return response.json()})
   .then(res =>{ console.log(JSON.stringify(res))})
    
  
  
  
    */
    var req = new XMLHttpRequest(); 
    var url = "http://localhost:7071/api/flightlist";

    req.open('GET', url, true);
    req.onload  = function() {
   var jsonResponse = JSON.parse(req.responseText);
   console.log(jsonResponse)
};
  req.send(null);
  
  
  } 
    let planes = [];

    function ProcessFlightData(flight) {


      len = flight.length - 1
      console.log(len)
      for (let i = 0; i < len; i++) {
        f = flight[i]

        var newFlightPin = new atlas.Shape(
          new atlas.data.Point([f[6], f[7]]),
          f[1]
        );
        //id del point=icao24!

        newFlightPin.addProperty("name", f[2]);
        newFlightPin.addProperty("baroAltitude", f[8]);
        newFlightPin.addProperty("rotation", f[11]);

        newFlightPin.addProperty("originCountry", f[3]);
        newFlightPin.addProperty("lastPosUpdate", f[4]);
        newFlightPin.addProperty("lastContact", f[5]);
        newFlightPin.addProperty("verticalRate", f[12]);
        newFlightPin.addProperty("velocity", f[10]);
        newFlightPin.addProperty("geoAltitude", f[14]);
        
        

        planes[f[1]] = newFlightPin;
      }
      datasource.setShapes(Object.values(planes));


      document.getElementById("messages").innerHTML = flight[len];


    }

    function closePopup() {
            popup.close();
        }

      function symbolHovered(e) {
            //Make sure the event occurred on a shape feature.
            if (e.shapes && e.shapes.length > 0) {
                var properties = e.shapes[0].getProperties();

                //Update the content and position of the popup.
                popup.setOptions({
                    //Create the content of the popup.
                    content: `<div style="padding:10px;"><b>FLIGHT NUMBER: ${properties.name}</b>
                      <br>Origin Country: ${properties.originCountry}</br>
                      <br>Last position update: ${properties.lastPosUpdate}</br>

                      <br>Last contact: ${properties.lastContact}</br>
                      <br>Barometric altitude: ${properties.baroAltitude}</br>

                      <br>Velocity: ${properties.velocity}</br>

                      <br>True Track: ${properties.rotatiion}</br>

                      <br>Vertical Rate: ${properties.verticalRate}</br>

                      <br>Geo Altitude: ${properties.geoAltitude}</br>


                      
                      </div>`
                      ,
                    position: e.shapes[0].getCoordinates(),
                    pixelOffset: [0, -18]
                });

                //Open the popup.
                popup.open(map);
            }
        }


  </script>

  <style>
    html,
    body {
      width: 80%;
      height: 80%;
      padding: 0;
      margin: 0;
    }

    #myMap {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body onload="GetMap();populate()">
  <div id="myMap"></div>
  <div id="messages"></div>
</body>

</html>