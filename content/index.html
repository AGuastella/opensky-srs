<!DOCTYPE html>
<html>

<head>
  <title>Live Flight Data Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>

  <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas-service.min.js"></script>
  <script>

    var map, datasource, popup, symbolLayer, planes = [];

    function GetMap() {
      map = new atlas.Map("myMap", {
        authOptions: {
          authType: "subscriptionKey",
          subscriptionKey: "2Xi2YAbxLSzp83ZIc_JDsxqxJ_FQsuIhV0MLlVkEOA0",
        },
        style: "night",
        center: [12.56738, 41.87194],
        zoom: 5

      });



      map.events.add("ready", function () {

        map.imageSprite.createFromTemplate('myTemplatedIcon', 'triangle-arrow-up', 'teal', '#fff')


        datasource = new atlas.source.DataSource();
        map.sources.add(datasource);

        symbolLayer = new atlas.layer.SymbolLayer(datasource, null, {
          iconOptions: {
            image: 'myTemplatedIcon',
            ignorePlacement: true,
            allowOverlap: true,
            size: 0.5,
            rotation: ["get", "rotation"],
          },

        })
        map.layers.add(symbolLayer);



        //let messages = document.querySelector('#messages');
        const apiBaseUrl = window.location.origin;
        const connection = new signalR.HubConnectionBuilder()
          .withUrl(apiBaseUrl + '/api')
          .configureLogging(signalR.LogLevel.Information)
          .build();
        popup = new atlas.Popup({
          position: [0, 0],
          pixelOffset: [0, -18]
        });
        map.events.add('mousemove', closePopup);
        map.events.add('mousemove', symbolLayer, symbolHovered);
        map.events.add('touchstart', symbolLayer, symbolHovered);
        /*fetch('https://openskyiu.azurewebsites.net/api/flightlist')
          .then(response => { return response.json() })
          .then(res => { ProcessFlightData(res) })
*/
        StartConnection(connection)

        connection.on('newMessage', ProcessFlightData)


      });



    }



    function ProcessFlightData(flight) {


      len = flight.length - 1
      console.log(len)
      for (let i = 0; i < len; i++) {
        f = flight[i]

        var newFlightPin = new atlas.Shape(
          new atlas.data.Point([f[6], f[7]]),
          f[1]
        );
        //id del point=icao24!

        newFlightPin.addProperty("name", f[2]);
        newFlightPin.addProperty("baroAltitude", f[8]);
        newFlightPin.addProperty("rotation", f[11]);

        newFlightPin.addProperty("originCountry", f[3]);
        newFlightPin.addProperty("lastPosUpdate", f[4]);
        newFlightPin.addProperty("lastContact", f[5]);
        newFlightPin.addProperty("verticalRate", f[12]);
        newFlightPin.addProperty("velocity", f[10]);
        newFlightPin.addProperty("geoAltitude", f[14]);



        planes[f[1]] = newFlightPin;
      }
      datasource.setShapes(Object.values(planes));


      document.getElementById("messages").innerHTML = flight[len];


    }

    function closePopup() {
      popup.close();
    }

    function symbolHovered(e) {
      //Make sure the event occurred on a shape feature.
      if (e.shapes && e.shapes.length > 0) {
        var properties = e.shapes[0].getProperties();

        //Update the content and position of the popup.
        popup.setOptions({
          //Create the content of the popup.
          content: `<div style="padding:10px;"><b>FLIGHT NUMBER: ${properties.name}</b>
                      <br>Origin Country: ${properties.originCountry}</br>
                      <br>Last position update: ${properties.lastPosUpdate}</br>

                      <br>Last contact: ${properties.lastContact}</br>
                      <br>Barometric altitude: ${properties.baroAltitude}</br>

                      <br>Velocity: ${properties.velocity}</br>

                      <br>True Track: ${properties.rotation}</br>

                      <br>Vertical Rate: ${properties.verticalRate}</br>

                      <br>Geo Altitude: ${properties.geoAltitude}</br>


                      
                      </div>`
          ,
          position: e.shapes[0].getCoordinates(),
          pixelOffset: [0, -18]
        });

        //Open the popup.
        popup.open(map);
      }
    }
    function StartConnection(connection) {
            console.log('connecting...')
            connection.start()
                .then(function () { console.log('connected!') })
                .catch(function (err) {
                    console.error(err)
                    setTimeout(function () { StartConnection(connection) }, 2000)
                })
        }
  </script>

  <style>
    html,
    body {
      width: 80%;
      height: 80%;
      padding: 0;
      margin: 0;
    }

    #myMap {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body onload="GetMap()">
  <div id="myMap"></div>
  <div id="messages"></div>
</body>

</html>